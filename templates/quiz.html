<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Quiz - GistQ</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
    font-family: "Charter", "Bitstream Charter", "Sitka Text", Cambria, serif;
    background: #faf8f5;
    min-height: 100vh;
    color: #1a1a1a;
    line-height: 1.6;
}

.container { 
    max-width: 100%;
    margin: 0;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
}

.header { 
    text-align: center; 
    padding: 40px 20px;
    border-bottom: 1px solid #f0f0f0;
}

.logo {
    font-size: 2em;
    font-weight: 300;
    letter-spacing: -0.03em;
    color: #1a1a1a;
    margin-bottom: 4px;
}

.subtitle {
    font-size: 0.95em;
    color: #999999;
    font-weight: 300;
}

.progress-bar {
    background: #f5f3f0;
    height: 2px;
    overflow: hidden;
}

.progress-fill {
    background: linear-gradient(90deg, #64b5f6, #90caf9);
    height: 100%;
    transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 0 10px rgba(33, 150, 243, 0.3);
}

.main-content {
    flex: 1;
    max-width: 800px;
    width: 100%;
    margin: 0 auto;
    padding: 60px 40px;
}

.question-header {
    margin-bottom: 40px;
    padding-bottom: 20px;
    border-bottom: 1px solid #f0f0f0;
}

.question-number {
    font-size: 0.75em;
    font-weight: 600;
    color: #2196f3;
    text-transform: uppercase;
    letter-spacing: 0.1em;
}

.question-text {
    font-size: 1.4em;
    font-weight: 300;
    margin-top: 24px;
    line-height: 1.7;
    color: #1a1a1a;
}

.answer-input {
    width: 100%;
    min-height: 200px;
    padding: 0;
    border: none;
    border-bottom: 1px solid #f0f0f0;
    font-size: 1.05em;
    resize: vertical;
    background: transparent;
    color: #1a1a1a;
    font-family: inherit;
    line-height: 1.8;
    transition: border-color 0.3s;
    margin-bottom: 40px;
}

.answer-input:focus {
    outline: none;
    border-bottom-color: #64b5f6;
}

.answer-input::placeholder {
    color: #cccccc;
}

.answer-feedback {
    margin-bottom: 24px;
    padding: 20px;
    border-radius: 0;
    display: none;
    font-size: 0.95em;
    border-left: 3px solid;
    font-weight: 300;
    line-height: 1.7;
}

.answer-feedback.show { display: block; }

.answer-feedback.correct {
    background: #f0f7ff;
    border-color: #64b5f6;
    color: #1a1a1a;
}

.answer-feedback.incorrect {
    background: #fff5f5;
    border-color: #ffcccc;
    color: #1a1a1a;
}

.correct-answer {
    background: #f5f3f0;
    padding: 20px;
    border-radius: 0;
    margin-bottom: 24px;
    display: none;
    border-left: 3px solid #e8e6e3;
}

.correct-answer.show { display: block; }

.correct-answer strong {
    display: block;
    margin-bottom: 12px;
    color: #999999;
    font-size: 0.75em;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    font-weight: 600;
}

.correct-answer-text {
    color: #1a1a1a;
    font-weight: 300;
    line-height: 1.7;
}

.button-group {
    display: flex;
    gap: 20px;
    margin-top: 40px;
}

.action-button {
    flex: 1;
    padding: 20px;
    font-size: 1em;
    border: 1px solid #f0f0f0;
    background: transparent;
    cursor: pointer;
    font-weight: 400;
    font-family: inherit;
    transition: all 0.3s;
    color: #1a1a1a;
}

.action-button:hover {
    background: #f0f7ff;
    border-color: #90caf9;
}

.action-button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.action-button:disabled:hover {
    background: transparent;
    border-color: #f0f0f0;
}

.action-button.primary {
    background: linear-gradient(135deg, #64b5f6, #90caf9);
    border-color: transparent;
    color: #ffffff;
    box-shadow: 0 2px 8px rgba(33, 150, 243, 0.25);
}

.action-button.primary:hover {
    background: linear-gradient(135deg, #42a5f5, #64b5f6);
    border-color: transparent;
    box-shadow: 0 4px 12px rgba(33, 150, 243, 0.35);
    transform: translateY(-1px);
}

.action-button.secondary {
    flex: 0 0 auto;
    padding: 20px 30px;
    color: #999999;
}

.action-button.secondary:hover {
    color: #1a1a1a;
}

.results-card {
    text-align: center;
    padding: 80px 40px;
    display: none;
}

.results-card.show { display: block; }

.results-title {
    font-size: 2em;
    font-weight: 300;
    margin-bottom: 60px;
    color: #1a1a1a;
}

.score-circle {
    width: 240px;
    height: 240px;
    border-radius: 50%;
    margin: 0 auto 60px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    font-size: 4em;
    font-weight: 200;
    border: 2px solid #f0f0f0;
    position: relative;
    transition: all 0.4s;
}

.score-circle.excellent {
    background: linear-gradient(135deg, #64b5f6, #90caf9);
    color: #ffffff;
    border-color: transparent;
    box-shadow: 0 8px 24px rgba(33, 150, 243, 0.3);
}

.score-circle.good {
    background: #f0f7ff;
    color: #2196f3;
    border-color: #90caf9;
}

.score-circle.needs-improvement {
    background: #f5f3f0;
    color: #666666;
    border-color: #e8e6e3;
}

.score-label {
    font-size: 0.2em;
    font-weight: 400;
    margin-top: 12px;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: inherit;
}

.results-message {
    font-size: 1.2em;
    font-weight: 300;
    margin: 40px 0;
    color: #1a1a1a;
}

.results-details {
    max-width: 400px;
    margin: 60px auto;
    text-align: left;
}

.detail-item {
    display: flex;
    justify-content: space-between;
    padding: 20px 0;
    border-bottom: 1px solid #f0f0f0;
    font-size: 0.95em;
    font-weight: 300;
}

.detail-item:last-child { border-bottom: none; }

.detail-item strong {
    font-weight: 400;
}

@media(max-width: 768px){
    .logo { font-size: 1.8em; }
    .main-content { padding: 40px 20px; }
    .question-text { font-size: 1.2em; }
    .score-circle { width: 200px; height: 200px; font-size: 3.5em; }
    .button-group { flex-direction: column; }
    .results-card { padding: 60px 20px; }
}
</style>
</head>
<body>
<div class="container">
    <div class="header">
        <div class="logo">GistQ</div>
        <div class="subtitle">Knowledge Testing</div>
    </div>

    <div class="progress-bar">
        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
    </div>

    <div class="main-content" id="quizContent">
        <div class="question-header">
            <div class="question-number" id="questionNumber">Question 1 of 5</div>
            <div class="question-text" id="questionText"></div>
        </div>

        <textarea 
            id="answerInput" 
            class="answer-input" 
            placeholder="Type your answer here...">
        </textarea>

        <div class="answer-feedback" id="feedback"></div>
        
        <div class="correct-answer" id="correctAnswer">
            <strong>Correct Answer</strong>
            <div class="correct-answer-text" id="correctAnswerText"></div>
        </div>

        <div class="button-group">
            <button class="action-button primary" id="btnCheck" onclick="checkAnswer()">
                Check Answer
            </button>
            <button class="action-button primary" id="btnNext" onclick="nextQuestion()" style="display: none;">
                Next Question →
            </button>
            <button class="action-button primary" id="btnSubmit" onclick="submitQuiz()" style="display: none;">
                Finish Quiz
            </button>
            <button class="action-button secondary" onclick="goHome()">
                Exit
            </button>
        </div>
    </div>

    <div class="results-card" id="resultsCard">
        <h2 class="results-title">Quiz Complete</h2>
        
        <div class="score-circle" id="scoreCircle">
            <div>
                <span id="scorePercentage">0</span>%
                <div class="score-label">Score</div>
            </div>
        </div>

        <div class="results-message" id="resultsMessage"></div>

        <div class="results-details">
            <div class="detail-item">
                <span>Correct Answers</span>
                <strong id="correctCount">0</strong>
            </div>
            <div class="detail-item">
                <span>Incorrect Answers</span>
                <strong id="incorrectCount">0</strong>
            </div>
            <div class="detail-item">
                <span>Total Questions</span>
                <strong id="totalCount">0</strong>
            </div>
        </div>

        <button class="action-button" onclick="goHome()" style="max-width: 300px; margin: 40px auto 0;">
            Return to Home
        </button>
    </div>
</div>

<script>
let questions = [];
let currentQuestionIndex = 0;
let userAnswers = [];
let scores = [];

window.addEventListener('DOMContentLoaded', function() {
    const quizDataStr = sessionStorage.getItem('quizData');
    
    if (!quizDataStr) {
        alert('No quiz data found. Redirecting to home...');
        window.location.href = '/';
        return;
    }

    try {
        questions = JSON.parse(quizDataStr);
        console.log('Loaded questions:', questions);
        
        if (!questions || questions.length === 0) {
            alert('No questions available. Redirecting to home...');
            window.location.href = '/';
            return;
        }
        
        loadQuestion();
    } catch(e) {
        console.error('Error loading quiz:', e);
        alert('Error loading quiz. Redirecting to home...');
        window.location.href = '/';
    }
});

function loadQuestion() {
    if (currentQuestionIndex >= questions.length) {
        showResults();
        return;
    }

    const question = questions[currentQuestionIndex];
    console.log('Loading question', currentQuestionIndex, ':', question);
    
    document.getElementById('questionNumber').textContent = 
        `Question ${currentQuestionIndex + 1} of ${questions.length}`;
    document.getElementById('questionText').textContent = question.question;
    document.getElementById('answerInput').value = '';
    
    const progress = ((currentQuestionIndex) / questions.length) * 100;
    document.getElementById('progressFill').style.width = progress + '%';
    
    const feedback = document.getElementById('feedback');
    feedback.className = 'answer-feedback';
    feedback.innerHTML = '';
    
    const correctAnswer = document.getElementById('correctAnswer');
    correctAnswer.className = 'correct-answer';
    document.getElementById('correctAnswerText').innerHTML = '';
    
    const btnCheck = document.getElementById('btnCheck');
    const btnNext = document.getElementById('btnNext');
    const btnSubmit = document.getElementById('btnSubmit');
    
    btnCheck.style.display = 'block';
    btnCheck.disabled = false;
    btnCheck.textContent = 'Check Answer';
    
    btnNext.style.display = 'none';
    btnSubmit.style.display = 'none';
    
    document.getElementById('answerInput').disabled = false;
    document.getElementById('answerInput').focus();
}

async function checkAnswer() {
    const userAnswer = document.getElementById('answerInput').value.trim();
    
    if (!userAnswer) {
        alert('Please enter an answer');
        return;
    }

    const question = questions[currentQuestionIndex];
    console.log('Checking answer for question:', question.question);
    
    document.getElementById('answerInput').disabled = true;
    document.getElementById('btnCheck').disabled = true;
    document.getElementById('btnCheck').textContent = 'Checking...';

    try {
        const response = await fetch('/verify_answer', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                question: question.question,
                user_answer: userAnswer,
                correct_answer: question.answer
            })
        });

        if (!response.ok) {
            throw new Error('Server error: ' + response.status);
        }

        const data = await response.json();
        console.log('Verification result:', data);
        
        if (data.error) {
            throw new Error(data.error);
        }

        userAnswers.push(userAnswer);
        scores.push(data.is_correct === true || data.is_correct === 'true');

        const feedback = document.getElementById('feedback');
        feedback.classList.add('show');
        
        if (data.is_correct === true || data.is_correct === 'true') {
            feedback.classList.add('correct');
            feedback.innerHTML = '✓ ' + (data.feedback || 'Correct answer');
        } else {
            feedback.classList.add('incorrect');
            feedback.innerHTML = '✗ ' + (data.feedback || 'Incorrect answer');
            
            const correctAnswerDiv = document.getElementById('correctAnswer');
            document.getElementById('correctAnswerText').textContent = question.answer;
            correctAnswerDiv.classList.add('show');
        }

        document.getElementById('btnCheck').style.display = 'none';
        
        if (currentQuestionIndex < questions.length - 1) {
            document.getElementById('btnNext').style.display = 'block';
        } else {
            document.getElementById('btnSubmit').style.display = 'block';
        }

    } catch(e) {
        console.error('Error:', e);
        alert('Error checking answer: ' + e.message);
        
        document.getElementById('answerInput').disabled = false;
        document.getElementById('btnCheck').disabled = false;
        document.getElementById('btnCheck').textContent = 'Check Answer';
    }
}

function nextQuestion() {
    console.log('Moving to next question. Current:', currentQuestionIndex);
    currentQuestionIndex++;
    loadQuestion();
}

function submitQuiz() {
    console.log('Submitting quiz');
    showResults();
}

function showResults() {
    const correctCount = scores.filter(s => s === true).length;
    const totalCount = scores.length;
    const percentage = totalCount > 0 ? Math.round((correctCount / totalCount) * 100) : 0;

    console.log('Final scores:', scores);
    console.log('Correct:', correctCount, 'Total:', totalCount, 'Percentage:', percentage);

    document.getElementById('quizContent').style.display = 'none';
    document.querySelector('.progress-bar').style.display = 'none';
    document.getElementById('resultsCard').classList.add('show');

    document.getElementById('scorePercentage').textContent = percentage;
    document.getElementById('correctCount').textContent = correctCount;
    document.getElementById('incorrectCount').textContent = totalCount - correctCount;
    document.getElementById('totalCount').textContent = totalCount;

    const scoreCircle = document.getElementById('scoreCircle');
    const message = document.getElementById('resultsMessage');
    
    if (percentage >= 80) {
        scoreCircle.className = 'score-circle excellent';
        message.textContent = 'Excellent work! You have a great understanding.';
    } else if (percentage >= 60) {
        scoreCircle.className = 'score-circle good';
        message.textContent = 'Good job! Keep practicing to improve.';
    } else {
        scoreCircle.className = 'score-circle needs-improvement';
        message.textContent = 'Keep learning! Review the material and try again.';
    }

    sessionStorage.removeItem('quizData');
}

function goHome() {
    window.location.href = '/';
}
</script>
</body>
</html>